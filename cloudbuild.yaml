steps:
  - name: 'bash'
    id: 'Generate Timestamp'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        export _FIXED_TIMESTAMP=$(date +%Y%m%d%H%M%S)
        echo "export _FIXED_TIMESTAMP=${_FIXED_TIMESTAMP}" > /workspace/env_vars.sh
    
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Backend Image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/env_vars.sh
        docker build --no-cache --pull -t us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-backend:${COMMIT_SHA}-${_FIXED_TIMESTAMP} api --build-arg CACHEBUSTER=${_FIXED_TIMESTAMP}'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Backend Image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/env_vars.sh
        docker push us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-backend:${COMMIT_SHA}-${_FIXED_TIMESTAMP}'

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Deploy Backend Service'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/env_vars.sh
        gcloud run deploy finmodel-backend-service \
          --image us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-backend:${COMMIT_SHA}-${_FIXED_TIMESTAMP} \
          --region us-east1 \
          --platform managed \
          --allow-unauthenticated \
          --project financial-model-cloud \
          --set-cloudsql-instances=financial-model-cloud:us-east1:finmodel-postgres-instance \
          --cpu=1 \
          --memory=512Mi \
          --concurrency=80 \
          --timeout=30m \
          --no-traffic

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Update Backend Traffic'
    args:
      - 'run'
      - 'services'
      - 'update-traffic'
      - 'finmodel-backend-service'
      - '--region'
      - 'us-east1'
      - '--to-latest'
      - '--project'
      - 'financial-model-cloud'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Frontend Image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/env_vars.sh
        docker build --no-cache -t us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-frontend:${COMMIT_SHA}-${_FIXED_TIMESTAMP} --build-arg=REACT_APP_API_URL=https://finmodel-backend-service-526419047208.us-east1.run.app .
    dir: 'ui'
    waitFor: ['Update Backend Traffic']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Frontend Image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/env_vars.sh
        docker push us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-frontend:${COMMIT_SHA}-${_FIXED_TIMESTAMP}'
    waitFor: ['Build Frontend Image']

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Deploy Frontend Service'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/env_vars.sh
        gcloud run deploy finmodel-frontend-service --image us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-frontend:${COMMIT_SHA}-${_FIXED_TIMESTAMP} --region us-east1 --platform managed --allow-unauthenticated --project financial-model-cloud
    waitFor: ['Push Frontend Image']

  - name: 'python:3.11'
    id: 'Run Alembic Migrations'
    dir: 'api'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        python3 -m pip install -r requirements.txt
        curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.20.0/cloud-sql-proxy.linux.amd64
        chmod +x cloud-sql-proxy
        mkdir -p /cloudsql
        ./cloud-sql-proxy financial-model-cloud:us-east1:finmodel-postgres-instance --unix-socket /cloudsql &
        
        echo "Waiting for Cloud SQL Proxy to start..." && for i in $(seq 1 10); do if [ -S /cloudsql/financial-model-cloud:us-east1:finmodel-postgres-instance/.s.PGSQL.5432 ]; then echo "Cloud SQL Proxy is ready!"; break; fi; echo "Still waiting..." && sleep 10; done && if ! [ -S /cloudsql/financial-model-cloud:us-east1:finmodel-postgres-instance/.s.PGSQL.5432 ]; then echo "ERROR: Cloud SQL Proxy did not start in time." && exit 1; fi
        alembic upgrade head
    env:
      - 'DB_USER=dbadmin'
      - 'DB_NAME=finmodel1'
      - 'CLOUD_SQL_CONNECTION_NAME=financial-model-cloud:us-east1:finmodel-postgres-instance'
    secretEnv:
      - '_DB_PASSWORD'
    timeout: 1800s

options:
  default_logs_bucket_behavior: 'REGIONAL_USER_OWNED_BUCKET'

availableSecrets:
  secretManager:
    - versionName: 'projects/financial-model-cloud/secrets/_DB_PASSWORD/versions/1'
      env: '_DB_PASSWORD'