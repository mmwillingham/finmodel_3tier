steps:\n  - name: \'gcr.io/cloud-builders/docker\'\n    id: \'Build Backend Image\'\n    entrypoint: \'bash\'\n    args:\n      - \'-c\'\n      - |\n        docker build --no-cache --pull -t us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-backend:$COMMIT_SHA-${_TIMESTAMP} api \\\n          --build-arg CACHEBUSTER=${_TIMESTAMP}\n\n  - name: \'gcr.io/cloud-builders/docker\'\n    id: \'Push Backend Image\'\n    entrypoint: \'bash\'\n    args:\n      - \'-c\'\n      - \'docker push us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-backend:$COMMIT_SHA-${_TIMESTAMP}\'\n\n  - name: \'gcr.io/cloud-builders/gcloud\'\n    id: \'Remove old secret env vars\'\n    args:\n      - \'run\'\n      - \'services\'\n      - \'update\'\n      - \'finmodel-backend-service\'\n      - \'--region\'\n      - \'us-east1\'\n      - \'--project\'\n      - \'financial-model-cloud\'\n      - \'--remove-env-vars=SECRET_KEY,DB_PASSWORD,GOOGLE_CLIENT_SECRET,MAIL_PASSWORD,GOOGLE_CLIENT_ID\'\n    allowFailure: true\n\n  - name: \'gcr.io/cloud-builders/gcloud\'\n    id: \'Deploy Backend Service\'\n    entrypoint: \'bash\'\n    args:\n      - \'-c\'\n      - |\n        gcloud run deploy finmodel-backend-service \\\n          --image us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-backend:$COMMIT_SHA-${_TIMESTAMP} \\\n          --region us-east1 \\\n          --platform managed \\\n          --allow-unauthenticated \\\n          --project financial-model-cloud \\\n          --no-traffic \\\n          --to-latest \\\n          --update-env-vars=DB_USER=dbadmin \\\n          --update-env-vars=DB_NAME=finmodel1 \\\n          --update-env-vars=CLOUD_SQL_CONNECTION_NAME=financial-model-cloud:us-east1:finmodel-postgres-instance \\\n          --update-env-vars=MAIL_USERNAME=martin.willingham@gmail.com \\\n          --update-env-vars=MAIL_FROM=no_reply@gmail.com \\\n          --update-env-vars=MAIL_PORT=587 \\\n          --update-env-vars=MAIL_SERVER=smtp.gmail.com \\\n          --update-env-vars=FRONTEND_URL=https://finmodel-frontend-service-526419047208.us-east1.run.app \\\n          --update-env-vars=PUBLIC_BACKEND_URL=https://finmodel-backend-service-526419047208.us-east1.run.app \\\n          --update-env-vars=MAIL_TLS=True \\\n          --update-env-vars=MAIL_SSL=False \\\n          --update-env-vars=USE_CREDENTIALS=True \\\n          --update-env-vars=VALIDATE_CERTS=True \\\n          --add-cloudsql-instances=financial-model-cloud:us-east1:finmodel-postgres-instance \\\n          --set-secrets=SECRET_KEY=_SECRET_KEY:1 \\\n          --set-secrets=DB_PASSWORD=_DB_PASSWORD:1 \\\n          --set-secrets=GOOGLE_CLIENT_SECRET=_GOOGLE_CLIENT_SECRET:2 \\\n          --set-secrets=GOOGLE_CLIENT_ID=_GOOGLE_CLIENT_ID:2 \\\n          --set-secrets=MAIL_PASSWORD=_MAIL_PASSWORD:1\n    secretEnv:\n      - \'_DB_PASSWORD\'\n      - \'_GOOGLE_CLIENT_SECRET\'\n      - \'_GOOGLE_CLIENT_ID\'\n      - \'_MAIL_PASSWORD\'\n      - \'_SECRET_KEY\'\n    waitFor: [\'Remove old secret env vars\']\n\n  - name: \'gcr.io/cloud-builders/docker\'\n    id: \'Build Frontend Image\'\n    args:\n      - \'build\'\n      - \'--no-cache\'\n      - \'-t\'\n      - \'us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-frontend:$COMMIT_SHA\'\n      - \'.\'\n    dir: \'ui\'\n    waitFor: [\'Deploy Backend Service\']\n\n  - name: \'gcr.io/cloud-builders/docker\'\n    id: \'Push Frontend Image\'\n    args:\n      - \'push\'\n      - \'us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-frontend:$COMMIT_SHA\'\n    waitFor: [\'Build Frontend Image\']\n\n  - name: \'gcr.io/cloud-builders/gcloud\'\n    id: \'Deploy Frontend Service\'\n    args:\
      - \'run\'\n      - \'deploy\'\n      - \'finmodel-frontend-service\'\n      - \'--image\'\n      - \'us-east1-docker.pkg.dev/financial-model-cloud/finmodel-repo/finmodel-frontend:$COMMIT_SHA\'\n      - \'--region\'\n      - \'us-east1\'\n      - \'--platform\'\n      - \'managed\'\n      - \'--allow-unauthenticated\'\n      - \'--project\'\n      - \'financial-model-cloud\'\n      - \'--update-env-vars=REACT_APP_API_URL=https://finmodel-backend-service-526419047208.us-east1.run.app\'\n    waitFor: [\'Push Frontend Image\']\n\n  - name: \'gcr.io/cloudsql-docker/gce-proxy:latest\' # Reverting to v1 proxy for Cloud Build migrations\n    id: \'cloudsql-proxy-service\' # Name this step as a service\n    entrypoint: \'/cloud_sql_proxy\'\n    args:\
      - \'-instances=financial-model-cloud:us-east1:finmodel-postgres-instance\'\n      - \'-port=5432\'\n      - \'-debug\' # Add debug logging to proxy\n    waitFor: [\'Deploy Frontend Service\'] # Start after frontend is deployed\n\n  - name: \'python:3.11\' # Standardize Python version\n    id: \'Run Alembic Migrations\'\n    dir: \'api\'\n    entrypoint: \'bash\'\n    args:\
      - \'-c\'\n      - |\n        python3 -m pip install -r requirements.txt\n        apt-get update && apt-get install -y netcat-traditional # Install netcat\n        \n        echo \"Waiting for Cloud SQL Proxy to start...\"\n        for i in `seq 1 10`; do\\\
          nc -z 127.0.0.1 5432 && echo \"Cloud SQL Proxy is ready!\" && break\\\
          echo \"Still waiting...\" && sleep 5;\\\
        done\n        nc -z 127.0.0.1 5432 || (echo \"ERROR: Cloud SQL Proxy did not start in time.\" && exit 1)\n        /usr/local/bin/alembic upgrade head\n    env:\
      - \'DB_USER=dbadmin\'\n      - \'DB_NAME=finmodel1\'\n      - \'DB_HOST=127.0.0.1\' # Connect to the proxy running on localhost\n      - \'DB_PORT=5432\'\n      - \'CLOUD_SQL_CONNECTION_NAME=financial-model-cloud:us-east1:finmodel-postgres-instance\'\n      - \'DB_PASSWORD=${_DB_PASSWORD}\'\n      - \'SECRET_KEY=${_SECRET_KEY}\'\n    secretEnv:\
      - \'_DB_PASSWORD\'\n    waitFor: [\'cloudsql-proxy-service\'] # Wait for the proxy service to start before running migrations\n\noptions:\
  default_logs_bucket_behavior: \'REGIONAL_USER_OWNED_BUCKET\'\n\navailableSecrets:\
  \ secretManager:\n    - versionName: \'projects/financial-model-cloud/secrets/_DB_PASSWORD/versions/1\'\n      env: \'_DB_PASSWORD\'\n    - versionName: \'projects/financial-model-cloud/secrets/_GOOGLE_CLIENT_SECRET/versions/2\'\n      env: \'_GOOGLE_CLIENT_SECRET\'\n    - versionName: \'projects/financial-model-cloud/secrets/_GOOGLE_CLIENT_ID/versions/2\'\n      env: \'_GOOGLE_CLIENT_ID\'\n    - versionName: \'projects/financial-model-cloud/secrets/_MAIL_PASSWORD/versions/1\'\n      env: \'_MAIL_PASSWORD\'\n    - versionName: \'projects/financial-model-cloud/secrets/_SECRET_KEY/versions/1\'\n      env: \'_SECRET_KEY\'\nsubstitutions:\n  _TIMESTAMP: $(date +%s)\n